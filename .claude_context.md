# Claude Context: DEFCON SSTV Badge

## Project Overview
This is an open-source SSTV (Slow Scan Television) badge for DEFCON and the badgelife community. The badge enables users to capture photos, encode them as SSTV signals, and transmit/receive via amateur radio.

## Hardware Architecture
- **MCU**: Raspberry Pi RP2350 (dual ARM Cortex-M33 cores)
- **Radio**: SA818 VHF/UHF transceiver module (1W output)
- **Camera**: OV2640 2MP camera module  
- **Display**: 2.4" TFT LCD (240x320, ST7789 controller)
- **Storage**: MicroSD card for image archival
- **Power**: 2000mAh LiPo battery with USB-C charging
- **Audio**: WM8960 codec for SSTV signal processing
- **Expansion**: 2x SAO (Shitty Add-On) connectors

## Software Architecture
**Dual-Core Design:**
- **Core 0**: User interface, file system, system management, display updates
- **Core 1**: SSTV encoding/decoding, audio DSP, camera control, radio management

## Development Environment
- **Language**: C11 (ISO/IEC 9899:2011)
- **Compiler**: GCC ARM Embedded (arm-none-eabi-gcc)
- **IDE**: CLion on macOS
- **Build System**: CMake with Raspberry Pi Pico SDK
- **Target**: ARM Cortex-M33 (ARMv8-M architecture)
- **Debugger**: OpenOCD + GDB via SWD

## Critical Real-Time Constraints and Architecture
**SSTV Timing Requirements (Critical):**
- Line sync pulses: 5ms ¬±0.1ms precision required
- Pixel timing: ~0.46ms per pixel (Martin M1 mode)
- Color component timing: 146.43ms total line time ¬±0.1%
- VIS code timing: 300ms sequence with precise bit timing
- Audio sample rates: 8-48kHz with minimal jitter

**RP2350 Real-Time Strategy:**
- **Core 0**: User interface, file system, system management (non-critical timing)
- **Core 1**: Dedicated SSTV processing, audio DSP, timing-critical operations
- **PIO State Machines**: Hardware-generated precise timing signals
- **DMA Controllers**: Audio codec data transfer without CPU intervention
- **Hardware Timers**: Microsecond-level timing accuracy
- **Interrupt Priorities**: SSTV processing gets highest priority levels
- **No Linux/RTOS**: Bare metal operation for deterministic timing

**Design Validation Requirements:**
- Oscilloscope verification of all timing-critical signals
- Dedicated SSTV core must have minimal interrupt latency
- Audio codec interface via DMA to eliminate timing jitter
- Optional co-processor footprint on PCB as fallback if needed

## Amateur Radio License Verification System
**Software-Based License Control:**
- Default mode: Receive-only for unlicensed users
- Licensed mode: Full TX/RX for verified amateur operators
- Callsign + device serial number generate unique unlock codes
- SHA-256 hash verification prevents casual circumvention
- Clear visual indicators of current operating mode
- Automatic callsign overlay on transmitted images (FCC requirement)

**Implementation:**
- First-boot callsign entry process
- Encrypted verification data stored in flash memory
- Educational amateur radio license information in UI
- Prominent license requirement warnings throughout system

## SA818 Module Swappability
**Hardware Design:**
- SA818 mounted in standard 16-pin DIP socket
- Pin-compatible SA818-V (VHF) and SA818-U (UHF) modules
- 2-position DIP switch for band detection
- Software reads switch to configure frequency ranges and limitations
- SMA connector accommodates band-appropriate antennas

**User Experience:**
- Tool-free module swapping (power-off required)
- Automatic firmware detection of installed band
- Frequency validation prevents out-of-band operation
- Visual band indicators on display

## Project Structure
```
defcon-sstv-badge/
‚îú‚îÄ‚îÄ docs/                      # Complete documentation
‚îÇ   ‚îú‚îÄ‚îÄ firmware-architecture.md   # Detailed software design
‚îÇ   ‚îú‚îÄ‚îÄ schematic.md              # Hardware connections  
‚îÇ   ‚îú‚îÄ‚îÄ bom.md                    # Bill of materials
‚îÇ   ‚îî‚îÄ‚îÄ assembly-notes.md         # Build instructions
‚îú‚îÄ‚îÄ firmware/                  # RP2350 embedded C code
‚îÇ   ‚îú‚îÄ‚îÄ src/                   # Main source code
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.c             # Entry point and initialization
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core0_main.c       # UI and system management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core1_main.c       # Signal processing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hardware/          # HAL and device drivers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sstv/              # SSTV encoding/decoding
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/                # User interface system
‚îÇ   ‚îú‚îÄ‚îÄ lib/                   # External libraries
‚îÇ   ‚îî‚îÄ‚îÄ examples/              # Test programs
‚îú‚îÄ‚îÄ hardware/                  # KiCAD PCB design files
‚îî‚îÄ‚îÄ mechanical/                # Badge accessories and mounting
```

## Development Priorities
1. **Phase 1**: Basic hardware initialization (GPIO, SPI, I2C, UART)
2. **Phase 2**: Device drivers (display, camera, SA818, audio codec)
3. **Phase 3**: Core system services (file system, power management)
4. **Phase 4**: SSTV signal processing algorithms
5. **Phase 5**: User interface and integration
6. **Phase 6**: Testing, optimization, and polish

## Current Development Status
- ‚úÖ **Hardware design**: Complete schematic and BOM
- ‚úÖ **Documentation**: Comprehensive technical docs
- ‚úÖ **Project structure**: Professional repository setup
- üîÑ **Firmware development**: Starting basic hardware drivers
- ‚è≥ **PCB layout**: Planned after firmware validation
- ‚è≥ **Prototype testing**: Following PCB fabrication

## Key Hardware Interfaces
```c
// Critical GPIO assignments (RP2350)
#define SA818_UART_TX    4    // SA818 control
#define SA818_UART_RX    5
#define DISPLAY_CS       16   // TFT display SPI
#define DISPLAY_DC       19
#define CAMERA_I2C_SDA   2    // OV2640 control
#define CAMERA_I2C_SCL   3
#define AUDIO_I2S_BCK    34   // WM8960 audio codec
#define AUDIO_I2S_WS     35
#define PHOTO_BUTTON     26   // User controls
#define DPAD_UP         22
// ... (see docs/schematic.md for complete pinout)
```

## Coding Standards
- **Style**: 4-space indentation, snake_case naming
- **Functions**: Doxygen-style documentation
- **Error handling**: Always check return values
- **Memory**: Avoid dynamic allocation, use static buffers
- **Hardware**: Volatile for registers, proper initialization
- **Real-time**: Understand timing constraints for SSTV

## SSTV Technical Details
- **Encoding**: Convert RGB image ‚Üí FM audio tones
- **Decoding**: Analyze audio spectrum ‚Üí reconstruct image
- **Timing**: Critical microsecond-level precision required
- **Modes**: Each mode has specific line timing and format
- **VIS codes**: Automatic mode detection via header tones

## Amateur Radio Compliance
- **License required**: Amateur radio license mandatory for operation
- **Frequency coordination**: Respect band plans and local coordination
- **Power limits**: 1W output complies with amateur allocations
- **Identification**: Callsign overlay on transmitted images
- **Spurious emissions**: Design meets amateur radio standards

## Build and Debug Workflow
```bash
# Build process
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make -j4

# Flash firmware
# Method 1: UF2 bootloader (hold BOOTSEL + USB)
cp defcon_sstv_badge.uf2 /Volumes/RPI-RP2/

# Method 2: SWD debugging  
openocd -f interface/cmsis-dap.cfg -f target/rp2040.cfg
# (then use CLion debugger)
```

## Common Development Tasks
When working on this project, you'll frequently need to:
- **Initialize hardware peripherals** (SPI, I2C, UART, GPIO)
- **Implement device drivers** with proper error handling
- **Handle real-time audio processing** for SSTV signals
- **Manage dual-core coordination** and shared resources
- **Debug timing-critical code** with oscilloscope verification
- **Optimize for memory and power constraints**

## Key Files to Reference
- `docs/firmware-architecture.md` - Complete software design
- `docs/schematic.md` - Hardware connections and pinout
- `firmware/src/main.c` - System initialization
- `CMakeLists.txt` - Build configuration

## Important Notes
- This is a **wearable badge** - no enclosure, PCB is the product
- **Real-time constraints** are critical for SSTV timing accuracy  
- **Dual-core architecture** requires careful resource sharing
- **Amateur radio regulations** must be followed for legal operation
- **Community project** - designed for badgelife and ham radio communities

---
*Context file version: 1.0*
*Last updated: [Current Date]*